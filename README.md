# NetAttackClassifier
ä¸€ä¸ªåŸºäºSnortè§„åˆ™å’ŒATT&CKæ¡†æ¶çš„ç½‘ç»œæµé‡åˆ†æä¸å¨èƒåˆ†ç±»å·¥å…·

* ğŸ•µï¸â™‚ï¸ åŸºäºSnortçš„å¼‚å¸¸æµé‡æ£€æµ‹
* ğŸ¯ ATT&CKæŠ€æˆ˜æœ¯æ˜ å°„
* ğŸ§¬ é«˜ç»†ç²’åº¦æµé‡åˆ†ç±»

## é¡¹ç›®ç®€ä»‹
åœ¨è®­ç»ƒæµé‡åˆ†ç±»æ¨¡å‹æ—¶, å¤§éƒ¨åˆ†éƒ½ä½¿ç”¨ç½‘ç»œä¸Šçš„å…¬å¼€æ•°æ®é›†, ä½†éƒ½å­˜åœ¨ä¸€ä¸ªå…±åŒçš„ç¼ºç‚¹, å°±æ˜¯å¯¹äºæµé‡çš„åˆ†ç±»ç»†ç²’åº¦ä¸å¤Ÿ, å¦‚æœèƒ½æŠŠæµé‡ä¸­ä½¿ç”¨çš„æ¼æ´ç¼–å·ã€æ¼æ´ç»†èŠ‚éƒ½åŒºåˆ†å‡ºæ¥æ‰æ˜¯åœ¨ä½¿ç”¨åœ¨å®æˆ˜ä¸­, ä½†å¤§éƒ¨åˆ†æ•°æ®é›†çš„æ„é€ æ–¹å¼è¦ä¹ˆæ˜¯æ ¹æ®å·²çŸ¥æ¼æ´æ–¹å¼ã€æ¶æ„è½¯ä»¶ç±»å‹å»äº§ç”Ÿå¯¹åº”çš„æµé‡(ä¾‹å¦‚`https://github.com/yungshenglu/USTC-TFC2016`ã€`https://github.com/safest-place/ExploitPcapCollection`), è¦ä¹ˆå°±æ˜¯å¤§é‡äººå·¥æ ¹æ®æœç´¢å¼•æ“ã€æ¼æ´ç¼–å·åº“ç­‰æ–¹å¼è¿›è¡Œäººå·¥åˆ†ç±»(æˆ‘äº†è§£åˆ°çš„ä¸€äº›å®‰å…¨å…¬å¸).
æ‰€ä»¥å†™äº†ä¸€ä¸ªæ ¹æ® Snort å¯¹æµé‡è¿›è¡Œæ£€æµ‹, è®©å¤§æ¨¡å‹å¯¹æ—¥å¿—è¿›è¡Œåˆ†æ, ä½¿å…¶å’ŒATT&CKæŠ€æˆ˜æœ¯è¿›è¡Œæ˜ å°„, ä»è€Œèƒ½è®©æµé‡è¿›è¡Œé«˜ç»†ç²’åº¦åˆ†ç±»

## é¡¹ç›®åŠŸèƒ½

* pcap æ–‡ä»¶æ£€æµ‹ï¼šä½¿ç”¨Snortè§„åˆ™å¯¹å¤§é‡pcapæ–‡ä»¶è¿›è¡Œæ£€æµ‹ï¼Œå¿«é€Ÿè¯†åˆ«å‡ºç¬¦åˆè§„åˆ™çš„å¯ç–‘æ•°æ®åŒ…åŠå…¶å¯¹åº”çš„ç½‘ç»œæµã€‚
* ATTCKæŠ€æˆ˜æœ¯æ˜ å°„ï¼šé€šè¿‡è°ƒç”¨DeepSeek APIï¼Œå°†æ£€æµ‹åˆ°çš„å¯ç–‘æ•°æ®åŒ…æ‰€è§¦å‘çš„Snortè§„åˆ™ä¸MITRE ATTCKæ¡†æ¶ä¸­çš„æŠ€æˆ˜æœ¯è¿›è¡Œæ˜ å°„ï¼Œæ˜ç¡®æ”»å‡»è€…å¯èƒ½é‡‡ç”¨çš„æ”»å‡»æ‰‹æ³•å’Œé˜¶æ®µã€‚
* é«˜ç»†ç²’åº¦å¤šåˆ†ç±»ï¼šå¯¹æ£€æµ‹å‡ºçš„å¯ç–‘pcapæµè¿›è¡Œè¿›ä¸€æ­¥çš„ç»†åˆ†å’Œåˆ†ç±»ï¼Œä»å¤šä¸ªç»´åº¦ï¼ˆå¦‚æ”»å‡»ç±»å‹ã€ç›®æ ‡ç³»ç»Ÿã€æ”»å‡»å·¥å…·ç­‰ï¼‰è¿›è¡Œè¯¦ç»†æ ‡æ³¨å’Œå½’ç±»ï¼Œä¸ºåç»­çš„å®‰å…¨åˆ†æå’Œå“åº”æä¾›æ›´ç²¾å‡†çš„ä¿¡æ¯ã€‚

## ç¯å¢ƒæ­å»º

* å®‰è£… Snort, é…ç½®ç›¸åº”çš„è§„åˆ™åº“(`https://www.snort.org/downloads#rules`), æˆ‘çš„æ­å»ºé…ç½®:

  ### **å®‰è£…Snort 3ä¾èµ–**

  ```bash
  # æ›´æ–°ç³»ç»Ÿ
  sudo apt update && sudo apt upgrade -y

  # å®‰è£…ç¼–è¯‘ä¾èµ–
  sudo apt install -y build-essential autotools-dev libdumbnet-dev \
  libluajit-5.1-dev libpcap-dev libpcre3-dev zlib1g-dev pkg-config \
  libhwloc-dev libcmocka-dev liblzma-dev openssl libssl-dev cpputest \
  libsqlite3-dev uuid-dev libtool git autoconf bison flex libnetfilter-queue-dev \
  libmnl-dev libunwind-dev libfl-dev libsafec-dev

  # å¯é€‰ï¼šå®‰è£…Hyperscanï¼ˆé«˜æ€§èƒ½æ­£åˆ™è¡¨è¾¾å¼åº“ï¼‰
  sudo apt install -y libhyperscan-dev

  # å®‰è£…CMakeï¼ˆç”¨äºæ„å»ºä¾èµ–é¡¹ï¼‰
  sudo apt install -y cmake
  ```

  ### **å®‰è£…DAQ 3.xä¾èµ–**

  ```bash
  # å®‰è£…ç¼–è¯‘DAQ 3.xæ‰€éœ€çš„ä¾èµ–
  sudo apt install -y libpcap-dev libdumbnet-dev libssl-dev liblzma-dev \
  libcurl4-openssl-dev libhwloc-dev libcmocka-dev libpcre3-dev bison flex
  ```

  ### **ä¸‹è½½å¹¶ç¼–è¯‘DAQ 3.x**

  ```bash
  # ä¸‹è½½DAQ 3.xæºç 
  cd ~/snort3_build
  git clone https://github.com/snort3/libdaq.git
  cd libdaq

  # é…ç½®ã€ç¼–è¯‘å’Œå®‰è£…
  ./bootstrap
  ./configure --prefix=/usr/local
  make -j$(nproc)
  sudo make install

  # æ›´æ–°åŠ¨æ€åº“é“¾æ¥
  sudo ldconfig
  ```

  ### **ä¸‹è½½å¹¶ç¼–è¯‘Snort 3**

  ```bash
  # åˆ›å»ºç¼–è¯‘ç›®å½•
  mkdir ~/snort3_build && cd ~/snort3_build

  # ä¸‹è½½Snort 3æºç 
  git clone https://github.com/snort3/snort3.git
  cd snort3

  # é…ç½®ç¼–è¯‘é€‰é¡¹
  ./configure_cmake.sh --prefix=/usr/local --enable-tcmalloc
  cd build

  # ç¼–è¯‘å¹¶å®‰è£…
  make -j$(nproc) && sudo make install
  ```

  ### **æ­¥éª¤ 4ï¼šé…ç½®ç¯å¢ƒå˜é‡**

  ```bash
  # æ·»åŠ Snort 3åˆ°PATH
  echo 'export PATH=/usr/local/bin:$PATH' >> ~/.bashrc
  source ~/.bashrc

  # éªŒè¯å®‰è£…
  snort -V
  ```

* ```bash
  pip install openai
  ```

## ä½¿ç”¨æ–¹æ³•

1. å°†pcapæ–‡ä»¶æ”¾ç½®åœ¨æŒ‡å®šçš„è¾“å…¥ç›®å½•ä¸‹ã€‚
2. è¿è¡Œ`run_snort.py`, å¯¹pcapè¿›è¡Œæ‰¹é‡æ£€æµ‹, å¹¶å¯¹æ—¥å¿—å†…å®¹è¿›è¡Œè§£æ, æå–å¨èƒä¿¡æ¯åˆ°æŒ‡å®š json æ–‡ä»¶ä¸­ã€‚
3. è¿è¡Œ`extract_tcp_streams.py`, é¦–å…ˆä½¿ç”¨`SplitCap.exe`(`https://www.netresec.com/?page=SplitCap`)å¯¹pcapè¿›è¡ŒTCPåŒå‘æµåˆ†æµæ“ä½œ, å†æ£€ç´¢ json æ–‡ä»¶ä¸­å­˜åœ¨å‘Šè­¦çš„åŒ…, è®¡ç®—æ•´æ¡æµä¸­æ¯ä¸ªåŒ…çš„`è§„åˆ™ä¼˜å…ˆçº§`ã€`è§¦å‘é¢‘æ¬¡`ã€`åè®®ä¸€è‡´æ€§`, å¾—åˆ°åŒä¸€æ¡æµä¸­æ¯ä¸ªåŒ…çš„`åŠ æƒå¹³å‡åˆ†æ•°`, é€‰å–å¾—åˆ†æœ€é«˜åŒ…çš„å‘Šè­¦æœ€ä¸ºè¯¥æµçš„å‘Šè­¦, è¿™æ˜¯ä¸ºäº†è®© Snort çš„åŒ…æ£€æµ‹æœºåˆ¶ä¸å¤§éƒ¨åˆ†æ¨¡å‹çš„æµæ£€æµ‹æœºåˆ¶å¯¹åº”èµ·æ¥, ä»è€Œå¾—åˆ°åˆ†æµåçš„pcapæ•°æ®åŒ…å’Œä¸ä¹‹å¯¹åº”çš„ json æ–‡ä»¶, ä¾‹å¦‚:

    ```json
    {
      "timestamp": "09/06-01:18:41.206357",
      "gid": 1,
      "sid": 45015,
      "rev": 3,
      "description": "FILE-OTHER Jackson databind deserialization remote code execution attempt",
      "classification": "Attempted User Privilege Gain",
      "priority": 1,
      "protocol": "TCP",
      "src_ip": "192.168.56.1",
      "dst_ip": "192.168.56.11",
      "src_port": 1056,
      "dst_port": 8090,
      "pcap_path": "/Users/lnhsec/Desktop/NetAttackClassifier/extracted_streams/fastjson1224ldap/192.168.56.1_1056_to_192.168.56.11_8090.pcap",
      "weight_score": 0.8031363764158987,
      "priority_score": 1.0,
      "frequency_score": 0.47712125471966244,
      "protocol_score": 0.8,
      "alert_count": 2
    }
    ```

4. è¿è¡Œ`gpt_analysis.py`, ä»ä¸Šé¢çš„ json æ–‡ä»¶æå–é‡è¦æµé‡ä¿¡æ¯, æ„é€ ç›¸åº”æç¤ºè¯, æäº¤ç»™gptå¯¹å…¶ä¸MITRE ATTCKæ¡†æ¶ä¸­çš„æŠ€æˆ˜æœ¯è¿›è¡Œæ˜ å°„, å¾—åˆ°å¯¹åº” json ç»“æœ, ä¾‹å¦‚:

    ```json
    {
      "attack_tactics": {
        "TA0006": "T1110"
      },
      "rule_trigger_reason": "An attempted Oracle login with a suspicious username triggered a misparsed login response alert",
      "attack_type": "Credential Brute Force Attempt",
      "behavior_pattern": "Suspicious username used in login attempt to Oracle server via TCP/1521",
      "threat_level": "medium",
      "suggested_action": "1. Investigate source IP 192.168.1.20 for compromise 2. Review Oracle account activity 3. Enforce strong authentication policies",
      "confidence": 0.9,
      "dynamic_behavior": {
        "network": {
          "ip": "192.168.1.20",
          "dns": ""
        }
      },
      "pcap_path": "/Users/lnhsec/Desktop/NetAttackClassifier/extracted_streams/msf_oracle_sid_brute/192.168.1.20_1521_to_192.168.1.14_34055.pcap"
    }

    ```

    æç¤ºè¯å¦‚ä¸‹:

    ```python
    def construct_prompt(key_info):
        prompt = """æ ¹æ®Snortå‘Šè­¦è¿›è¡Œç½‘ç»œå®‰å…¨äº‹ä»¶åˆ†æï¼Œè¦æ±‚ï¼š
            1. ä¸¥æ ¼éµå¾ªMITRE ATT&CKæŠ€æˆ˜æœ¯æ¡†æ¶åˆ†ç±»
            2. attack_tacticså­—æ®µå¿…é¡»åŒ…å«ç›¸å…³TAå’ŒTç¼–å·
            3. æ¯ä¸ªTAç¼–å·å¿…é¡»å¯¹åº”å…·ä½“ä¸”æ­£ç¡®çš„çš„TæŠ€æœ¯ç¼–å·
        """
        prompt += "æ ¹æ®ä»¥ä¸‹ Snort å‘Šè­¦ä¿¡æ¯ï¼Œè¿›è¡Œåˆ†æå¹¶æŒ‰ç…§ JSON æ ¼å¼è¿”å›ï¼š\n"
        for entry in key_info:
            prompt += (
                f"æ—¶é—´: {entry['timestamp']}, å‘Šè­¦ID: {entry['sid']}:{entry['gid']}:{entry['rev']}, "
                f"æè¿°: {entry['description']}, åˆ†ç±»: {entry['classification']}, "
                f"ä¼˜å…ˆçº§: {entry['priority']}, åè®®: {entry['protocol']}, "
                f"æºIP: {entry['src_ip']}:{entry['src_port']}, ç›®çš„IP: {entry['dst_ip']}:{entry['dst_port']}\n"
            )

        prompt += '''\nè¯·å›ç­”ä»¥ä¸‹é—®é¢˜å¹¶è¿”å› JSON æ ¼å¼:
            {
            "attack_tactics": {"TAxxxx": "Txxxx"},
            "rule_trigger_reason": "xxx",
            "attack_type": "xxx",
            "behavior_pattern": "xxx",
            "threat_level": "low/medium/high/critical",
            "suggested_action": "xxx",
            "confidence": 0.9,
            "dynamic_behavior": {
                "network": {"ip": "xxx", "dns": "xxx"}
            }
        }'''
        prompt += "\nè¯·ä¸¥æ ¼è¿”å›ç¬¦åˆ JSON æ ¼å¼çš„å†…å®¹ï¼Œä¸è¦åŒ…å«å…¶ä»–è¯´æ˜æ–‡å­—ï¼Œåªè¿”å› JSON ä¸²ã€‚"
        print(f"æ„é€ çš„ DeepSeek API è¾“å…¥å†…å®¹: {prompt}")
        return prompt
    ```

5. æœ€ç»ˆæ ¹æ®æŠ€æˆ˜æœ¯æˆ–è€…`attack_type`å¯¹ç›¸åº”æ–‡ä»¶è¿›è¡Œåˆ†ç±»æ“ä½œ

## æœªæ¥æ–¹å‘

1. **è§„åˆ™åº“ä¼˜åŒ–ï¼š** å› è§„åˆ™åº“çš„ä¸åŒç±»å‹ã€ç‰ˆæœ¬, å¾ˆå¤šå·²çŸ¥æ¶æ„pcapå¹¶æ²¡æœ‰è¢« Snort æ£€æµ‹å‡ºæ¥, è¿™ä¼šå¯¼è‡´å¾ˆå¤šæ¼æŠ¥æˆ–è€…è¯¯æŠ¥
2. **æ£€æµ‹æœºåˆ¶æ”¹è¿›ï¼š** åœ¨åŒ…æ£€æµ‹ä¸æµæ£€æµ‹çš„å¯¹åº”æ–¹æ³•éœ€è¦è¿›ä¸€æ­¥å®Œå–„, æŸ¥çœ‹æ˜¯å¦æœ‰æ›´å¥½çš„åŠæ³•
3. **æ€§èƒ½ä¼˜åŒ–ï¼š** è°ƒç”¨gpt apiè¿›è¡Œæ˜ å°„çš„æ—¶é—´æˆæœ¬è¾ƒé«˜, å°è¯•è¿‡ deepseek-v3 æ¨¡å‹(è¾ƒå¿«, ä½†å­˜åœ¨ä¹±è¯´çš„æƒ…å†µ), deepseek-r1 æ¨¡å‹(å¾ˆæ…¢, ä½†æ˜¯è¾ƒä¸ºå‡†ç¡®), çœ‹åç»­ç”¨ä¸ç”¨æ·»åŠ éƒ¨åˆ†çŸ¥è¯†åº“, ä½¿ç”¨å…¶ä»–è¾ƒå¿«æ¨¡å‹è¿›è¡Œæ˜ å°„